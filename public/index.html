<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sophia's Scribbles - A Cozy Corner for Thoughts</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="home-page">
  <header>
    <div class="header-container">
      <a href="/" class="logo" aria-label="Go to homepage" title="Go to homepage">Sophia's Scribbles</a>
      <div class="header-actions">
        <div class="search-container">
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Search posts..."
            aria-label="Search blog posts by title, excerpt, or author"
            title="Search blog posts by title, excerpt, or author"
          >
        </div>
        <div class="menu-wrapper" aria-label="Quick actions menu">
          <button class="menu-toggle" id="menuToggle" aria-haspopup="true" aria-expanded="false" aria-label="Open quick actions menu">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <div class="menu-dropdown" role="menu">
            <div class="menu-list" role="none">
              <a class="menu-item" href="#home" data-page="home" role="menuitem" aria-label="Go to home page" title="Go to home page">Home</a>
              <a class="menu-item" href="#about" data-page="about" role="menuitem" aria-label="Go to about page" title="Go to about page">About</a>
              <a class="menu-item" href="#posts" data-page="posts" role="menuitem" aria-label="Go to posts page" title="Go to posts page">Posts</a>
              <button type="button" id="contrastToggle" class="menu-item" aria-label="Switch to high contrast" title="Switch to high contrast" role="menuitem">Switch to high contrast</button>
              <a href="/login.html" class="menu-item" role="menuitem" aria-label="Admin login" title="Login to admin panel">Admin Login</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="app">
      <div class="loading">Loading posts...</div>
    </div>
  </div>

  <!-- Newsletter Section -->
  <section class="newsletter-section" aria-label="Newsletter subscription">
    <div class="newsletter-container">
      <h2>üì¨ Subscribe to Sophia's Newsletter</h2>
      <p>Get the latest posts and musings delivered straight to your inbox!</p>
      <form id="newsletterForm" class="newsletter-form" aria-label="Newsletter subscription form">
        <input 
          type="email" 
          id="newsletterEmail" 
          placeholder="Enter your email address..." 
          required
          aria-label="Email address for newsletter subscription"
          title="Enter your email to subscribe to the newsletter"
        >
        <button type="submit" class="newsletter-btn" aria-label="Subscribe to newsletter" title="Click to subscribe to the newsletter">Subscribe</button>
      </form>
      <div id="newsletterMessage" class="newsletter-message" role="status" aria-live="polite"></div>
      <p class="newsletter-privacy">We respect your privacy. Unsubscribe at any time.</p>
    </div>
  </section>

  <script>
    // Router
    const app = document.getElementById('app');
    let currentPage = 'home';
    let allBlogs = []; // Store all blogs for searching
    let searchQuery = '';
    let isAdmin = false; // Track if user is logged in as admin
    const welcomeGreetings = [
      'Welcome',
      '¬°Bienvenido!',
      'Bienvenue',
      'Willkommen',
      'Benvenuto',
      'Velkommen',
      'ÌôòÏòÅÌï©ÎãàÎã§',
      '„Çà„ÅÜ„Åì„Åù',
      'Ê¨¢Ëøé',
      'Namaste',
      'Sawasdee',
      'Karibu'
    ];
    let welcomeRotationTimer = null;

    // Get blog ID from URL
    function getBlogIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('post');
    }

    // Sort blogs based on criteria
    function sortBlogs(blogs, sortType) {
      const blogsCopy = [...blogs];
      
      switch(sortType) {
        case 'recent':
          // Already sorted by date (newest first) from API
          return blogsCopy;
        
        case 'az':
          // Sort alphabetically by title
          return blogsCopy.sort((a, b) => a.title.localeCompare(b.title));
        
        case 'popular':
          // For now, sort by date as we don't have view counts
          // In the future, this could be based on actual popularity metrics
          return blogsCopy.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        default:
          return blogsCopy;
      }
    }

    // Load all blogs
    async function loadBlogs() {
      try {
        app.innerHTML = '<div class="loading">Loading posts...</div>';
        const response = await fetch('/api/blogs');
        const blogs = await response.json();
        
        // Store all blogs for searching
        allBlogs = blogs;

        // Filter blogs based on search query
        let filteredBlogs = searchQuery 
          ? blogs.filter(blog => 
              blog.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
              blog.excerpt.toLowerCase().includes(searchQuery.toLowerCase()) ||
              blog.author.toLowerCase().includes(searchQuery.toLowerCase())
            )
          : blogs;

        // Get current sort preference from localStorage or default to 'recent'
        const currentSort = localStorage.getItem('postSort') || 'recent';

        // Sort blogs based on selection
        filteredBlogs = sortBlogs(filteredBlogs, currentSort);

        if (filteredBlogs.length === 0) {
          app.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-light);">
              <h2 style="color: var(--deep-purple); margin-bottom: 1rem;">No posts found</h2>
              <p>${searchQuery ? `No posts match "${searchQuery}"` : 'No blog posts available yet.'}</p>
            </div>
          `;
          return;
        }

        // Create header with sort dropdown
        const headerDiv = document.createElement('div');
        headerDiv.style.display = 'flex';
        headerDiv.style.justifyContent = 'space-between';
        headerDiv.style.alignItems = 'center';
        headerDiv.style.marginBottom = '2rem';
        headerDiv.style.flexWrap = 'wrap';
        headerDiv.style.gap = '1rem';
        
        headerDiv.innerHTML = `
          <h2 style="color: var(--deep-purple); font-size: 2rem; margin: 0;">All Posts</h2>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <label for="sortSelect" style="color: var(--text-light); font-weight: 600;">Sort by:</label>
            <select id="sortSelect" 
              style="padding: 0.5rem 1rem; border: 2px solid var(--light-purple); border-radius: 8px; background: white; color: var(--deep-purple); font-weight: 600; cursor: pointer; font-size: 1rem;"
              aria-label="Sort posts by"
              title="Choose how to sort posts">
              <option value="recent" ${currentSort === 'recent' ? 'selected' : ''}>Most Recent</option>
              <option value="az" ${currentSort === 'az' ? 'selected' : ''}>A-Z</option>
              <option value="popular" ${currentSort === 'popular' ? 'selected' : ''}>Most Popular</option>
            </select>
          </div>
        `;

        const blogGrid = document.createElement('div');
        blogGrid.className = 'blog-grid';

        // Show search results count if searching
        if (searchQuery.trim()) {
          const searchInfo = document.createElement('div');
          searchInfo.style.marginBottom = '2rem';
          searchInfo.style.padding = '1rem';
          searchInfo.style.background = 'var(--pale-purple)';
          searchInfo.style.borderRadius = '8px';
          searchInfo.style.color = 'var(--deep-purple)';
          searchInfo.style.fontWeight = 'bold';
          searchInfo.textContent = `Found ${filteredBlogs.length} post${filteredBlogs.length !== 1 ? 's' : ''} matching "${searchQuery}"`;
          
          const clearBtn = document.createElement('button');
          clearBtn.textContent = '‚úï Clear search';
          clearBtn.style.marginLeft = '1rem';
          clearBtn.style.padding = '0.3rem 0.8rem';
          clearBtn.style.background = 'var(--deep-purple)';
          clearBtn.style.color = 'white';
          clearBtn.style.border = 'none';
          clearBtn.style.borderRadius = '4px';
          clearBtn.style.cursor = 'pointer';
          clearBtn.onclick = () => {
            document.getElementById('searchInput').value = '';
            searchQuery = '';
            loadBlogs(true);
          };
          searchInfo.appendChild(clearBtn);
          
          app.innerHTML = '';
          app.appendChild(headerDiv);
          app.appendChild(searchInfo);
          app.appendChild(blogGrid);
        } else {
          app.innerHTML = '';
          app.appendChild(headerDiv);
          app.appendChild(blogGrid);
        }

        filteredBlogs.forEach(blog => {
          const card = document.createElement('div');
          card.className = 'blog-card';
          card.onclick = () => {
            window.location.href = `/?post=${blog.id}`;
          };

          const date = new Date(blog.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });

          card.innerHTML = `
            <h2>${escapeHtml(blog.title)}</h2>
            <div class="blog-meta">
              <span>By ${escapeHtml(blog.author)}</span>
              <span>${date}</span>
            </div>
            <p class="blog-excerpt">${escapeHtml(blog.excerpt)}</p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <a href="/?post=${blog.id}" class="read-more" onclick="event.stopPropagation()" aria-label="Read full post: ${escapeHtml(blog.title)}" title="Read the full post">Read more ‚Üí</a>
              ${isAdmin ? `<button onclick="event.stopPropagation(); window.location.href='/?post=${blog.id}&edit=true'" style="padding: 0.5rem 1rem; background: var(--primary-purple); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" aria-label="Edit post: ${escapeHtml(blog.title)}" title="Edit this post">‚úèÔ∏è Edit</button>` : ''}
            </div>
          `;

          blogGrid.appendChild(card);
        });

        // Add event listener for sort dropdown
        setTimeout(() => {
          const sortSelect = document.getElementById('sortSelect');
          if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
              localStorage.setItem('postSort', e.target.value);
              loadBlogs();
            });
          }
        }, 0);
      } catch (error) {
        console.error('Error loading blogs:', error);
        app.innerHTML = '<div class="error">Failed to load blog posts. Please try again later.</div>';
      }
    }

    // Load single blog post
    async function loadBlogPost(id, editMode = false) {
      try {
        const response = await fetch(`/api/blogs/${id}`);

        if (!response.ok) {
          throw new Error('Blog not found');
        }

        const blog = await response.json();

        const date = new Date(blog.date).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        if (editMode && isAdmin) {
          // Store original values for change detection
          const originalValues = {
            title: blog.title,
            author: blog.author,
            excerpt: blog.excerpt,
            content: blog.rawContent
          };

          // Show edit form
          app.innerHTML = `
            <a href="#posts" class="back-button" id="backToPostsBtn" aria-label="Go back to all posts" title="Return to posts list">‚Üê Back to all posts</a>
            <article class="blog-post">
              <h1 style="color: var(--deep-purple); margin-bottom: 2rem;">‚úèÔ∏è Edit Post</h1>
              
              <!-- Image Upload Section -->
              <div style="background: var(--pale-purple); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;" role="region" aria-label="Image upload section">
                <h3 style="color: var(--deep-purple); margin-bottom: 1rem;">üì∑ Upload Image</h3>
                <p style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">Upload an image and copy the markdown code to insert it into your post content.</p>
                <div style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 200px;">
                    <input type="file" id="editImageUpload" accept="image/*" 
                      style="width: 100%; padding: 0.5rem; border: 2px solid var(--light-purple); border-radius: 8px; background: white;"
                      aria-label="Choose image file to upload"
                      title="Select an image file (max 5MB)">
                  </div>
                  <button type="button" id="editUploadImageBtn" class="submit-btn" style="padding: 0.75rem 1.5rem;" aria-label="Upload selected image" title="Upload the selected image">Upload Image</button>
                </div>
                <div id="editImageMessage" style="margin-top: 1rem;"></div>
                <div id="editUploadedImages" style="margin-top: 1rem;"></div>
              </div>

              <form id="editPostForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                  <label for="editTitle" style="display: block; font-weight: bold; margin-bottom: 0.5rem; color: var(--deep-purple);">Title</label>
                  <input type="text" id="editTitle" value="${escapeHtml(blog.title)}" required
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-purple); border-radius: 8px; font-size: 1.1rem;"
                    aria-label="Post title"
                    title="Enter the post title">
                </div>
                <div>
                  <label for="editAuthor" style="display: block; font-weight: bold; margin-bottom: 0.5rem; color: var(--deep-purple);">Author</label>
                  <input type="text" id="editAuthor" value="${escapeHtml(blog.author)}"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-purple); border-radius: 8px; font-size: 1rem;"
                    aria-label="Post author name"
                    title="Enter the author name">
                </div>
                <div>
                  <label for="editExcerpt" style="display: block; font-weight: bold; margin-bottom: 0.5rem; color: var(--deep-purple);">Excerpt (Optional)</label>
                  <input type="text" id="editExcerpt" value="${escapeHtml(blog.excerpt)}"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-purple); border-radius: 8px; font-size: 1rem;"
                    aria-label="Post excerpt or summary"
                    title="Enter a short excerpt or summary">
                </div>
                <div>
                  <label for="editCoverImage" style="display: block; font-weight: bold; margin-bottom: 0.5rem; color: var(--deep-purple);">Cover Image URL (Optional)</label>
                  <input type="text" id="editCoverImage" value="${escapeHtml(blog.coverImage || '')}"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--light-purple); border-radius: 8px; font-size: 1rem;"
                    aria-label="Cover image URL"
                    title="Paste an image URL for the homepage card">
                  <small style="display: block; margin-top: 0.5rem; color: var(--text-light);">Use an image uploaded via the admin panel (e.g., /uploads/cover.jpg).</small>
                </div>
                <div>
                  <label for="editContent" style="display: block; font-weight: bold; margin-bottom: 0.5rem; color: var(--deep-purple);">Content (Markdown)</label>
                  <textarea id="editContent" required
                    style="width: 100%; min-height: 400px; padding: 0.75rem; border: 2px solid var(--light-purple); border-radius: 8px; font-size: 1rem; font-family: 'Courier New', monospace;"
                    aria-label="Post content in markdown format"
                    title="Enter the post content using markdown syntax">${escapeHtml(blog.rawContent)}</textarea>
                </div>
                <div id="editMessage" style="padding: 1rem; border-radius: 8px; display: none;" role="status" aria-live="polite"></div>
                <div style="display: flex; gap: 1rem;">
                  <button type="submit" class="submit-btn" id="saveEditBtn" aria-label="Save changes to post" title="Save all changes to this post">Save Changes</button>
                  <button type="button" class="back-button" id="cancelEditBtn" style="padding: 1rem 2.5rem;" aria-label="Cancel editing" title="Cancel editing and return to posts">Cancel</button>
                </div>
              </form>
            </article>
          `;

          // Function to check if there are unsaved changes
          function hasUnsavedChanges() {
            return (
              document.getElementById('editTitle').value !== originalValues.title ||
              document.getElementById('editAuthor').value !== originalValues.author ||
              document.getElementById('editExcerpt').value !== originalValues.excerpt ||
              document.getElementById('editContent').value !== originalValues.content
            );
          }

          // Handle back button click
          document.getElementById('backToPostsBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (hasUnsavedChanges()) {
              if (confirm('You have unsaved changes. Do you want to save them before leaving?')) {
                // Save and then navigate
                savePostEdit(id).then(() => {
                  window.history.pushState({}, '', '/#posts');
                  currentPage = 'posts';
                  loadBlogs();
                });
              } else {
                // Discard changes and navigate
                window.history.pushState({}, '', '/#posts');
                currentPage = 'posts';
                loadBlogs();
              }
            } else {
              // No changes, just navigate
              window.history.pushState({}, '', '/#posts');
              currentPage = 'posts';
              loadBlogs();
            }
          });

          // Handle cancel button click
          document.getElementById('cancelEditBtn').addEventListener('click', () => {
            if (hasUnsavedChanges()) {
              if (confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                window.history.pushState({}, '', '/#posts');
                currentPage = 'posts';
                loadBlogs();
              }
            } else {
              window.history.pushState({}, '', '/#posts');
              currentPage = 'posts';
              loadBlogs();
            }
          });

          // Handle image upload in edit mode
          document.getElementById('editUploadImageBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('editImageUpload');
            const file = fileInput.files[0];
            const messageDiv = document.getElementById('editImageMessage');
            const uploadedImagesDiv = document.getElementById('editUploadedImages');
            const uploadBtn = document.getElementById('editUploadImageBtn');
            
            if (!file) {
              messageDiv.innerHTML = '<div style="padding: 0.75rem; background: #f8d7da; color: #721c24; border-radius: 6px; border: 2px solid #f5c6cb;">Please select an image file</div>';
              return;
            }

            if (file.size > 5 * 1024 * 1024) {
              messageDiv.innerHTML = '<div style="padding: 0.75rem; background: #f8d7da; color: #721c24; border-radius: 6px; border: 2px solid #f5c6cb;">Image size must be less than 5MB</div>';
              return;
            }

            const formData = new FormData();
            formData.append('image', file);

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            messageDiv.innerHTML = '';

            try {
              const response = await fetch('/api/upload-image', {
                method: 'POST',
                body: formData
              });

              const data = await response.json();

              if (response.ok) {
                messageDiv.innerHTML = '<div style="padding: 0.75rem; background: #d4edda; color: #155724; border-radius: 6px; border: 2px solid #c3e6cb;">‚úì Image uploaded successfully!</div>';
                
                // Display uploaded image with markdown code
                const imageCard = document.createElement('div');
                imageCard.style.padding = '1rem';
                imageCard.style.background = 'white';
                imageCard.style.borderRadius = '8px';
                imageCard.style.marginTop = '1rem';
                imageCard.innerHTML = `
                  <img src="${data.url}" alt="Uploaded" style="max-width: 200px; border-radius: 8px; margin-bottom: 0.5rem;">
                  <div style="margin-bottom: 0.5rem;">
                    <strong>Markdown code:</strong>
                  </div>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" value="${data.markdown}" readonly 
                      style="flex: 1; padding: 0.5rem; border: 2px solid var(--light-purple); border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                    <button onclick="navigator.clipboard.writeText('${data.markdown}').then(() => alert('Copied to clipboard!'))" 
                      style="padding: 0.5rem 1rem; background: var(--deep-purple); color: white; border: none; border-radius: 4px; cursor: pointer;">
                      Copy
                    </button>
                  </div>
                  <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                    Paste this code into the Content field above to display the image.
                  </p>
                `;
                
                uploadedImagesDiv.innerHTML = '';
                uploadedImagesDiv.appendChild(imageCard);
                fileInput.value = '';
              } else {
                messageDiv.innerHTML = `<div style="padding: 0.75rem; background: #f8d7da; color: #721c24; border-radius: 6px; border: 2px solid #f5c6cb;">${data.error || 'Failed to upload image'}</div>`;
              }
            } catch (error) {
              console.error('Image upload error:', error);
              messageDiv.innerHTML = '<div style="padding: 0.75rem; background: #f8d7da; color: #721c24; border-radius: 6px; border: 2px solid #f5c6cb;">Failed to upload image. Please try again.</div>';
            } finally {
              uploadBtn.disabled = false;
              uploadBtn.textContent = 'Upload Image';
            }
          });

          // Handle form submission
          document.getElementById('editPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await savePostEdit(id);
          });
        } else {
          // Show normal post view
          app.innerHTML = `
            <a href="#posts" class="back-button" onclick="event.preventDefault(); window.history.pushState({}, '', '/#posts'); currentPage = 'posts'; loadBlogs(); updateActiveTab();" aria-label="Go back to all posts" title="Return to posts list">‚Üê Back to all posts</a>
            <article class="blog-post" role="article">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <h1>${escapeHtml(blog.title)}</h1>
                ${isAdmin ? `<button onclick="loadBlogPost('${id}', true)" style="padding: 0.6rem 1.2rem; background: var(--primary-purple); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;" aria-label="Edit this post" title="Edit this post">‚úèÔ∏è Edit Post</button>` : ''}
              </div>
              <div class="blog-meta">
                <span>By ${escapeHtml(blog.author)}</span>
                <span>${date}</span>
              </div>
              ${(blog.coverImage || '').trim() ? `<div class="blog-cover-wrapper">
                <img src="${escapeHtml(blog.coverImage)}" alt="Cover image for ${escapeHtml(blog.title)}" class="blog-cover-image" loading="lazy">
              </div>` : ''}
              <div class="blog-content">
                ${blog.content}
              </div>
            </article>
          `;
        }
      } catch (error) {
        console.error('Error loading blog post:', error);
        app.innerHTML = `
          <a href="#posts" class="back-button" onclick="event.preventDefault(); window.history.pushState({}, '', '/#posts'); currentPage = 'posts'; loadBlogs(); updateActiveTab();">‚Üê Back to all posts</a>
          <div class="error">Failed to load blog post. It may have been deleted.</div>
        `;
      }
    }

    // Save post edit
    async function savePostEdit(id) {
      const saveBtn = document.getElementById('saveEditBtn');
      const editMessage = document.getElementById('editMessage');
      
      const updateData = {
        title: document.getElementById('editTitle').value,
        author: document.getElementById('editAuthor').value,
        excerpt: document.getElementById('editExcerpt').value,
        coverImage: document.getElementById('editCoverImage').value,
        content: document.getElementById('editContent').value
      };

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      editMessage.style.display = 'none';

      try {
        const response = await fetch(`/api/blogs/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });

        const data = await response.json();

        if (response.ok) {
          editMessage.innerHTML = '‚úì Post updated successfully! Redirecting...';
          editMessage.style.background = '#d4edda';
          editMessage.style.color = '#155724';
          editMessage.style.border = '2px solid #c3e6cb';
          editMessage.style.display = 'block';
          
          // Navigate to posts list after a short delay
          setTimeout(() => {
            window.history.pushState({}, '', '/#posts');
            currentPage = 'posts';
            loadBlogs();
          }, 1000);
        } else {
          throw new Error(data.error || 'Failed to update post');
        }
      } catch (error) {
        console.error('Error updating post:', error);
        editMessage.innerHTML = '‚úó ' + error.message;
        editMessage.style.background = '#f8d7da';
        editMessage.style.color = '#721c24';
        editMessage.style.border = '2px solid #f5c6cb';
        editMessage.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getCoverImageMarkup(blog) {
      const cover = (blog.coverImage || '').trim();

      if (!cover) {
        return '';
      }

      const safeTitle = escapeHtml(blog.title);
      return `<img src="${escapeHtml(cover)}" alt="Cover image for ${safeTitle}" loading="lazy">`;
    }

    function initWelcomeRotation() {
      const welcomeWordEl = document.getElementById('welcomeWord');

      if (welcomeRotationTimer) {
        clearTimeout(welcomeRotationTimer);
        welcomeRotationTimer = null;
      }

      if (!welcomeWordEl || !welcomeGreetings.length) {
        return;
      }

      let greetingIndex = 0;
      let charIndex = 0;
      let isDeleting = false;

      const type = () => {
        const word = welcomeGreetings[greetingIndex];

        if (!isDeleting) {
          welcomeWordEl.textContent = word.slice(0, charIndex + 1);
          charIndex++;

          if (charIndex === word.length) {
            isDeleting = true;
            welcomeRotationTimer = setTimeout(type, 1800);
            return;
          }
        } else {
          welcomeWordEl.textContent = word.slice(0, Math.max(charIndex - 1, 0));
          charIndex--;

          if (charIndex === 0) {
            isDeleting = false;
            greetingIndex = (greetingIndex + 1) % welcomeGreetings.length;
          }
        }

        const delay = isDeleting ? 80 : 130;
        welcomeRotationTimer = setTimeout(type, delay);
      };

      type();
    }

    // Load home page with the two latest posts
    async function loadHome() {
      try {
        // Fetch all blogs to get the latest 2 entries
        const response = await fetch('/api/blogs');
        const blogs = await response.json();
        const latestBlogs = blogs.slice(0, 2); // take the first 2 (already date-sorted)

        let latestPostsHTML = '';
        if (latestBlogs.length > 0) {
          const previewCards = latestBlogs.map(blog => {
            const date = new Date(blog.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            const excerpt = blog.excerpt ? escapeHtml(blog.excerpt) : 'Tap to read this cozy story.';

            return `
              <article class="blog-card blog-card--preview" role="article" onclick="window.location.href='/?post=${blog.id}'">
                ${blog.coverImage ? `
                <div class="blog-card-image">
                  ${getCoverImageMarkup(blog)}
                  <div class="blog-card-overlay">
                    <p>${excerpt}</p>
                    <button type="button" class="read-more-button" onclick="event.stopPropagation(); window.location.href='/?post=${blog.id}'">Read more ‚Üí</button>
                  </div>
                </div>` : `
                <div class="blog-card-preview-only">
                  <p>${excerpt}</p>
                  <button type="button" class="read-more-button" onclick="event.stopPropagation(); window.location.href='/?post=${blog.id}'">Read more ‚Üí</button>
                </div>`}
                <h3 class="blog-card-title">${escapeHtml(blog.title)}</h3>
                <p class="blog-card-meta">By ${escapeHtml(blog.author)} ‚Ä¢ ${date}</p>
              </article>
            `;
          }).join('');

          latestPostsHTML = `
            <section style="margin-top: 3rem;">
              <h2 style="font-size: 2rem; color: var(--deep-purple); margin-bottom: 1rem; text-align: center;">Latest Posts</h2>
              <hr style="border: none; border-top: 2px solid var(--light-purple); max-width: 200px; margin: 0 auto 2rem;">
              <div class="home-preview-grid">
                ${previewCards}
              </div>
              <div style="text-align: center; margin-top: 2rem;">
                <a href="#posts" style="display: inline-block; padding: 1rem 2rem; background: var(--primary-purple); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;" 
                  onmouseover="this.style.background='var(--deep-purple)'" 
                  onmouseout="this.style.background='var(--primary-purple)'"
                  aria-label="View all posts"
                  title="View all blog posts">
                  View All Posts ‚Üí
                </a>
              </div>
            </section>
          `;
        }

        app.innerHTML = `
          <div style="text-align: center; padding: 4rem 2rem 2rem; color: var(--text-light);">
            <h1 style="font-size: 2.5rem; color: var(--deep-purple); margin-bottom: 0.5rem;">
              <span id="welcomeWord" aria-live="polite">Welcome</span>
              <span style="margin: 0 0.4rem;">to</span>
              Sophia's Scribbles
            </h1>
            <p style="font-size: 1.2rem; font-style: italic;">A cozy corner for thoughts, stories, and musings</p>
          </div>
          ${latestPostsHTML}
        `;
        initWelcomeRotation();
      } catch (error) {
        console.error('Error loading home page:', error);
        app.innerHTML = `
          <div style="text-align: center; padding: 4rem 2rem; color: var(--text-light);">
            <h1 style="font-size: 2.5rem; color: var(--deep-purple); margin-bottom: 0.5rem;">
              <span id="welcomeWord" aria-live="polite">Welcome</span>
              <span style="margin: 0 0.4rem;">to</span>
              Sophia's Scribbles
            </h1>
            <p style="font-size: 1.2rem; font-style: italic;">A cozy corner for thoughts, stories, and musings</p>
          </div>
        `;
        initWelcomeRotation();
      }
    }

    // Load about page
    async function loadAbout() {
      try {
        app.innerHTML = '<div class="loading">Loading...</div>';
        const response = await fetch('/api/about');
        const about = await response.json();

        app.innerHTML = `
          <article class="blog-post">
            <h1>${escapeHtml(about.title)}</h1>
            <div class="blog-content">
              ${about.htmlContent}
            </div>
          </article>
        `;
      } catch (error) {
        console.error('Error loading about page:', error);
        app.innerHTML = '<div class="error">Failed to load about page.</div>';
      }
    }

    // Initialize app
    function init() {
      const blogId = getBlogIdFromUrl();
      const hash = window.location.hash.slice(1) || 'home';
      const urlParams = new URLSearchParams(window.location.search);
      const editMode = urlParams.get('edit') === 'true';

      if (blogId) {
        currentPage = 'posts';
        loadBlogPost(blogId, editMode && isAdmin);
      } else if (hash === 'about') {
        currentPage = 'about';
        loadAbout();
      } else if (hash === 'posts') {
        currentPage = 'posts';
        loadBlogs();
      } else {
        currentPage = 'home';
        loadHome();
      }
      updateActiveTab();
    }

    // Handle browser back/forward and hash changes
    window.addEventListener('popstate', init);
    window.addEventListener('hashchange', init);

    const menuToggle = document.getElementById('menuToggle');
    const menuWrapper = document.querySelector('.menu-wrapper');
    const contrastToggle = document.getElementById('contrastToggle');
    const HIGH_CONTRAST_KEY = 'highContrastMode';

    function applyHighContrastMode(enabled) {
      if (enabled) {
        document.body.classList.add('high-contrast');
        contrastToggle.textContent = 'Switch to default contrast';
      } else {
        document.body.classList.remove('high-contrast');
        contrastToggle.textContent = 'Switch to high contrast';
      }
    }

    const storedContrast = localStorage.getItem(HIGH_CONTRAST_KEY) === 'true';
    applyHighContrastMode(storedContrast);

    contrastToggle.addEventListener('click', () => {
      const enabled = !document.body.classList.contains('high-contrast');
      applyHighContrastMode(enabled);
      localStorage.setItem(HIGH_CONTRAST_KEY, enabled);
    });

    if (menuToggle && menuWrapper) {
      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menuWrapper.classList.contains('open');
        menuWrapper.classList.toggle('open', !isOpen);
        menuToggle.setAttribute('aria-expanded', String(!isOpen));
      });

      document.addEventListener('click', (event) => {
        if (!menuWrapper.contains(event.target)) {
          menuWrapper.classList.remove('open');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Handle tab navigation
    document.querySelectorAll('.nav-tabs a').forEach(link => {
      link.addEventListener('click', (e) => {
        const page = link.getAttribute('data-page');
        
        // Clear any blog post query params
        if (window.location.search) {
          window.history.pushState({}, '', '/');
        }
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Update active state
        updateActiveTab();
      });
    });

    // Update active tab based on current page
    function updateActiveTab() {
      const hash = window.location.hash.slice(1) || 'home';
      const pageToHighlight = currentPage || hash;
      document.querySelectorAll('.nav-tabs a').forEach(a => {
        a.classList.remove('active');
        if (a.getAttribute('data-page') === pageToHighlight) {
          a.classList.add('active');
        }
      });
    }

    // Check if user is logged in as admin
    async function checkAdminStatus() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        isAdmin = data.authenticated || false;
        
        // Update admin button text if logged in
        if (isAdmin) {
          const adminBtn = document.querySelector('.admin-login-btn');
          if (adminBtn && adminBtn.textContent.includes('Admin')) {
            adminBtn.textContent = '‚öôÔ∏è Admin Panel';
            adminBtn.href = '/admin';
          }
        }
      } catch (error) {
        console.error('Error checking admin status:', error);
        isAdmin = false;
      }
    }

    // Start the app
    checkAdminStatus().then(() => {
      init();
      updateActiveTab();
    });

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;

    searchInput.addEventListener('input', (e) => {
      // Debounce search to avoid too many updates
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = e.target.value;
        
        // Only search if on posts page
        if (currentPage === 'posts' || searchQuery.trim()) {
          // Switch to posts page if searching
          if (searchQuery.trim() && currentPage !== 'posts') {
            window.location.hash = '#posts';
            currentPage = 'posts';
            updateActiveTab();
          }
          
          if (currentPage === 'posts') {
            loadBlogs(true);
          }
        }
      }, 300); // Wait 300ms after user stops typing
    });

    // Clear search when changing pages
    window.addEventListener('hashchange', () => {
      const hash = window.location.hash.slice(1) || 'home';
      if (hash !== 'posts' && searchQuery) {
        searchInput.value = '';
        searchQuery = '';
      }
    });

    // Newsletter subscription handler
    const newsletterForm = document.getElementById('newsletterForm');
    const newsletterMessage = document.getElementById('newsletterMessage');

    newsletterForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('newsletterEmail').value;
      const submitBtn = newsletterForm.querySelector('.newsletter-btn');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Subscribing...';
      newsletterMessage.textContent = '';
      newsletterMessage.className = 'newsletter-message';

      try {
        const response = await fetch('/api/newsletter/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        if (response.ok) {
          newsletterMessage.textContent = data.message || 'Thank you for subscribing! üéâ';
          newsletterMessage.className = 'newsletter-message success';
          newsletterForm.reset();
        } else {
          newsletterMessage.textContent = data.error || 'Something went wrong. Please try again.';
          newsletterMessage.className = 'newsletter-message error';
        }
      } catch (error) {
        console.error('Newsletter subscription error:', error);
        newsletterMessage.textContent = 'Unable to subscribe. Please try again later.';
        newsletterMessage.className = 'newsletter-message error';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subscribe';
      }
    });
  </script>
</body>
</html>
