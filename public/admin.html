<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Sophia's Scribbles</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="header-container">
      <a href="/" class="logo" aria-label="Go to homepage" title="Go to homepage">Sophia's Scribbles</a>
      <nav class="nav-tabs" aria-label="Main navigation">
        <a href="/" aria-label="Go to home page" title="Go to home page">Home</a>
        <a href="/#about" aria-label="Go to about page" title="Go to about page">About</a>
        <a href="/#posts" aria-label="Go to posts page" title="Go to posts page">Posts</a>
      </nav>
      <div class="search-container">
        <input 
          type="text" 
          class="search-input" 
          placeholder="üîç Search posts..."
          disabled
          style="opacity: 0.5; cursor: not-allowed;"
          title="Search available on main site"
          aria-label="Search disabled in admin panel"
        >
      </div>
      <button id="logoutBtn" class="admin-login-btn" style="background: rgba(220, 38, 38, 0.9); border-color: rgba(220, 38, 38, 0.5);" aria-label="Logout from admin panel" title="Click to logout">Logout</button>
    </div>
  </header>

  <div class="admin-container">
    <div id="message"></div>

    <div class="upload-form">
      <h2>‚úèÔ∏è Edit About Page</h2>
      <form id="aboutForm" aria-label="Edit about page form">
        <div class="form-group">
          <label for="aboutTitle">Page Title</label>
          <input type="text" id="aboutTitle" name="title" required placeholder="About Sophia"
            aria-label="About page title"
            title="Enter the title for the about page">
        </div>

        <div class="form-group">
          <label for="aboutContent">Page Content (Markdown)</label>
          <textarea id="aboutContent" name="content" placeholder="# About Me

Write about yourself here using markdown...

## Section Heading

You can use **bold**, *italic*, [links](https://example.com), and more!"
            aria-label="About page content in markdown format"
            title="Enter the about page content using markdown syntax"></textarea>
        </div>

        <button type="submit" class="submit-btn" id="aboutSubmitBtn" aria-label="Update about page" title="Save changes to the about page">Update About Page</button>
      </form>
    </div>

    <div class="upload-form">
      <h2>üì∑ Upload Images for Posts</h2>
      <p style="color: var(--text-light); margin-bottom: 1rem;">Upload images to use in your blog posts. Copy the markdown code and paste it into your post content.</p>
      
      <div class="form-group">
        <label for="imageUpload">Choose Image (Max 5MB)</label>
        <input type="file" id="imageUpload" accept="image/*"
          aria-label="Choose image file to upload"
          title="Select an image file (max 5MB)">
        <button type="button" class="submit-btn" id="uploadImageBtn" style="margin-top: 1rem;" aria-label="Upload selected image" title="Upload the selected image to use in posts">Upload Image</button>
      </div>

      <div id="imageUploadMessage" style="margin-top: 1rem;"></div>
      
      <div id="uploadedImages" style="margin-top: 1.5rem;"></div>
    </div>

    <div class="upload-form">
      <h2>Create New Post</h2>
      <form id="blogForm">
        <div class="form-group">
          <label for="title">Post Title *</label>
          <input type="text" id="title" name="title" required placeholder="Enter your post title...">
        </div>

        <div class="form-group">
          <label for="author">Author Name</label>
          <input type="text" id="author" name="author" placeholder="Sophia (optional)">
        </div>

        <div class="form-group">
          <label for="excerpt">Excerpt (Optional)</label>
          <input type="text" id="excerpt" name="excerpt" placeholder="A short preview of your post...">
        </div>

        <div class="form-group">
          <label>Content Method</label>
          <div style="margin-bottom: 1rem;">
            <label style="display: inline; font-weight: normal; margin-right: 2rem;">
              <input type="radio" name="contentMethod" value="write" checked> Write here
            </label>
            <label style="display: inline; font-weight: normal;">
              <input type="radio" name="contentMethod" value="upload"> Upload markdown file
            </label>
          </div>
        </div>

        <div class="form-group" id="contentArea">
          <label for="content">Post Content (Markdown) *</label>
          <textarea id="content" name="content" placeholder="# Your Post Title

Write your post here using markdown...

## Subheading

You can use **bold**, *italic*, [links](https://example.com), and more!

### Adding Images
Upload an image above, copy the markdown code, and paste it here:
![Image description](/uploads/your-image.jpg)

- Bullet points
- Are supported too

> Blockquotes look great!

\`\`\`
Code blocks work as well!
\`\`\`
"></textarea>
        </div>

        <div class="form-group" id="fileArea" style="display: none;">
          <label for="file">Upload Markdown File</label>
          <input type="file" id="file" name="file" accept=".md,.markdown,.txt">
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Publish Post</button>
      </form>
    </div>

    <div class="blog-list">
      <h2>Manage Posts</h2>
      <div id="blogsList">
        <div class="loading">Loading posts...</div>
      </div>
    </div>

    <div class="blog-list" style="margin-top: 2rem;">
      <h2>üì¨ Newsletter Subscribers</h2>
      <div id="subscribersList">
        <div class="loading">Loading subscribers...</div>
      </div>
    </div>
  </div>

  <script>
    const aboutForm = document.getElementById('aboutForm');
    const blogForm = document.getElementById('blogForm');
    const messageDiv = document.getElementById('message');
    const blogsListDiv = document.getElementById('blogsList');
    const contentArea = document.getElementById('contentArea');
    const fileArea = document.getElementById('fileArea');
    const submitBtn = document.getElementById('submitBtn');
    const aboutSubmitBtn = document.getElementById('aboutSubmitBtn');

    // Toggle between write and upload modes
    document.querySelectorAll('input[name="contentMethod"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (e.target.value === 'write') {
          contentArea.style.display = 'block';
          fileArea.style.display = 'none';
          document.getElementById('content').required = true;
          document.getElementById('file').required = false;
        } else {
          contentArea.style.display = 'none';
          fileArea.style.display = 'block';
          document.getElementById('content').required = false;
          document.getElementById('file').required = true;
        }
      });
    });

    // Show message
    function showMessage(text, type = 'success') {
      messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
      setTimeout(() => {
        messageDiv.innerHTML = '';
      }, 5000);
    }

    // Load all blogs for management
    async function loadBlogsForManagement() {
      try {
        const response = await fetch('/api/blogs');
        const blogs = await response.json();

        if (blogs.length === 0) {
          blogsListDiv.innerHTML = '<div class="empty-state">No posts yet. Create your first one above!</div>';
          return;
        }

        blogsListDiv.innerHTML = '';
        blogs.forEach(blog => {
          const item = document.createElement('div');
          item.className = 'blog-item';

          const date = new Date(blog.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });

          item.innerHTML = `
            <div class="blog-item-info">
              <h3>${escapeHtml(blog.title)}</h3>
              <p>By ${escapeHtml(blog.author)} ‚Ä¢ ${date}</p>
            </div>
            <button class="delete-btn" onclick="deleteBlog('${blog.id}', '${escapeHtml(blog.title)}')">Delete</button>
          `;

          blogsListDiv.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading blogs:', error);
        blogsListDiv.innerHTML = '<div class="error">Failed to load posts.</div>';
      }
    }

    // Delete blog
    async function deleteBlog(id, title) {
      if (!confirm(`Are you sure you want to delete "${title}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/blogs/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error('Failed to delete');
        }

        showMessage('Post deleted successfully!', 'success');
        loadBlogsForManagement();
      } catch (error) {
        console.error('Error deleting blog:', error);
        if (error.message && error.message.includes('401')) {
          showMessage('Session expired. Please login again.', 'error');
          setTimeout(() => window.location.href = '/login.html', 2000);
        } else {
          showMessage('Failed to delete post. Please try again.', 'error');
        }
      }
    }

    // Make deleteBlog available globally
    window.deleteBlog = deleteBlog;

    // Handle form submission
    blogForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(blogForm);
      const contentMethod = formData.get('contentMethod');

      // Remove contentMethod from formData
      formData.delete('contentMethod');

      // If using write mode, remove file
      if (contentMethod === 'write') {
        formData.delete('file');
      } else {
        // If using upload mode, remove content
        formData.delete('content');
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Publishing...';

      try {
        const response = await fetch('/api/blogs', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Failed to create post');
        }

        const result = await response.json();
        showMessage('Post published successfully!', 'success');
        blogForm.reset();
        loadBlogsForManagement();

        // Reset to write mode
        document.querySelector('input[name="contentMethod"][value="write"]').checked = true;
        contentArea.style.display = 'block';
        fileArea.style.display = 'none';
      } catch (error) {
        console.error('Error creating post:', error);
        if (error.message && error.message.includes('401')) {
          showMessage('Session expired. Please login again.', 'error');
          setTimeout(() => window.location.href = '/login.html', 2000);
        } else {
          showMessage('Failed to publish post. Please try again.', 'error');
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Publish Post';
      }
    });

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Image upload functionality
    const imageUploadInput = document.getElementById('imageUpload');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imageUploadMessage = document.getElementById('imageUploadMessage');
    const uploadedImagesDiv = document.getElementById('uploadedImages');

    uploadImageBtn.addEventListener('click', async () => {
      const file = imageUploadInput.files[0];
      
      if (!file) {
        imageUploadMessage.innerHTML = '<div class="message error">Please select an image file</div>';
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        imageUploadMessage.innerHTML = '<div class="message error">Image size must be less than 5MB</div>';
        return;
      }

      const formData = new FormData();
      formData.append('image', file);

      uploadImageBtn.disabled = true;
      uploadImageBtn.textContent = 'Uploading...';
      imageUploadMessage.innerHTML = '';

      try {
        const response = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          imageUploadMessage.innerHTML = '<div class="message success">Image uploaded successfully!</div>';
          
          // Display uploaded image with markdown code
          const imageCard = document.createElement('div');
          imageCard.style.padding = '1rem';
          imageCard.style.background = 'var(--pale-purple)';
          imageCard.style.borderRadius = '8px';
          imageCard.style.marginBottom = '1rem';
          imageCard.innerHTML = `
            <img src="${data.url}" alt="Uploaded" style="max-width: 200px; border-radius: 8px; margin-bottom: 0.5rem;">
            <div style="margin-bottom: 0.5rem;">
              <strong>Markdown code (copy this):</strong>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input type="text" value="${data.markdown}" readonly 
                style="flex: 1; padding: 0.5rem; border: 2px solid var(--light-purple); border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
              <button onclick="copyMarkdown('${data.markdown}')" 
                style="padding: 0.5rem 1rem; background: var(--deep-purple); color: white; border: none; border-radius: 4px; cursor: pointer;">
                Copy
              </button>
            </div>
            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
              Paste this code anywhere in your post content to display the image.
            </p>
          `;
          
          uploadedImagesDiv.insertBefore(imageCard, uploadedImagesDiv.firstChild);
          imageUploadInput.value = '';
        } else {
          imageUploadMessage.innerHTML = `<div class="message error">${data.error || 'Failed to upload image'}</div>`;
        }
      } catch (error) {
        console.error('Image upload error:', error);
        imageUploadMessage.innerHTML = '<div class="message error">Failed to upload image. Please try again.</div>';
      } finally {
        uploadImageBtn.disabled = false;
        uploadImageBtn.textContent = 'Upload Image';
      }
    });

    // Copy markdown to clipboard
    window.copyMarkdown = function(markdown) {
      navigator.clipboard.writeText(markdown).then(() => {
        showMessage('Markdown code copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showMessage('Failed to copy. Please copy manually.', 'error');
      });
    };

    // Load About page content into form
    async function loadAboutPage() {
      try {
        const response = await fetch('/api/about');
        const about = await response.json();
        
        document.getElementById('aboutTitle').value = about.title;
        document.getElementById('aboutContent').value = about.content;
      } catch (error) {
        console.error('Error loading about page:', error);
        showMessage('Failed to load About page content.', 'error');
      }
    }

    // Handle About form submission
    aboutForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('aboutTitle').value;
      const content = document.getElementById('aboutContent').value;
      
      aboutSubmitBtn.disabled = true;
      aboutSubmitBtn.textContent = 'Updating...';

      try {
        const response = await fetch('/api/about', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title, content })
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('About page updated successfully!', 'success');
        } else {
          throw new Error(data.error || 'Failed to update');
        }
      } catch (error) {
        console.error('Error updating about page:', error);
        if (error.message && error.message.includes('401')) {
          showMessage('Session expired. Please login again.', 'error');
          setTimeout(() => window.location.href = '/login.html', 2000);
        } else {
          showMessage('Failed to update About page. Please try again.', 'error');
        }
      } finally {
        aboutSubmitBtn.disabled = false;
        aboutSubmitBtn.textContent = 'Update About Page';
      }
    });

    // Check authentication on page load
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        
        if (!data.authenticated) {
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
      }
    }

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to logout?')) {
        return;
      }

      try {
        const response = await fetch('/api/logout', {
          method: 'POST'
        });

        if (response.ok) {
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Logout failed:', error);
        alert('Failed to logout. Please try again.');
      }
    });

    // Remove subscriber
    async function removeSubscriber(id, email) {
      if (!confirm(`Are you sure you want to remove "${email}" from the newsletter?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/newsletter/subscribers/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error('Failed to remove subscriber');
        }

        showMessage('Subscriber removed successfully!', 'success');
        loadSubscribers();
      } catch (error) {
        console.error('Error removing subscriber:', error);
        showMessage('Failed to remove subscriber. Please try again.', 'error');
      }
    }

    // Make removeSubscriber available globally
    window.removeSubscriber = removeSubscriber;

    // Load newsletter subscribers
    async function loadSubscribers() {
      const subscribersListDiv = document.getElementById('subscribersList');
      
      try {
        const response = await fetch('/api/newsletter/subscribers');
        const subscribers = await response.json();

        if (subscribers.length === 0) {
          subscribersListDiv.innerHTML = '<div class="empty-state">No subscribers yet.</div>';
          return;
        }

        subscribersListDiv.innerHTML = '';
        
        // Add count header
        const countDiv = document.createElement('div');
        countDiv.style.padding = '1rem';
        countDiv.style.background = 'var(--pale-purple)';
        countDiv.style.borderRadius = '8px';
        countDiv.style.marginBottom = '1rem';
        countDiv.style.fontWeight = 'bold';
        countDiv.style.color = 'var(--deep-purple)';
        countDiv.textContent = `Total Subscribers: ${subscribers.length}`;
        subscribersListDiv.appendChild(countDiv);

        subscribers.forEach(subscriber => {
          const item = document.createElement('div');
          item.className = 'blog-item';

          const date = new Date(subscriber.subscribedAt).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          item.innerHTML = `
            <div class="blog-item-info">
              <h3>${escapeHtml(subscriber.email)}</h3>
              <p>Subscribed on ${date}</p>
            </div>
            <button class="delete-btn" onclick="removeSubscriber('${subscriber.id}', '${escapeHtml(subscriber.email)}')">Remove</button>
          `;

          subscribersListDiv.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading subscribers:', error);
        subscribersListDiv.innerHTML = '<div class="error">Failed to load subscribers.</div>';
      }
    }

    // Initialize
    checkAuth();
    loadAboutPage();
    loadBlogsForManagement();
    loadSubscribers();
  </script>
</body>
</html>
